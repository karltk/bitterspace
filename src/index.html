<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv='Content-type: text/html; charset=utf-8'>
		<meta charset='utf-8'>
		<title>Bitter Space</title>
		<script type='text/javascript' src='game.js'></script>
		<script type='text/javascript' src='painter.js'></script>
		<style type='text/css'>
			#board, #genome
			{
				/*border: 1px solid black;*/
				display: inline-block;
			}
		</style>
		<script type="text/javascript" src="jquery.js"></script>
		<script type="text/javascript">
		
			$(document).ready(function() {
				
				var MAXX = 30;
				var MAXY = 20;
				var FOOD = 30;
				var ENEMIES = 50
				var TIMEOUT = 30;
				
				var canvas = document.getElementById('board');
				var sim = new Simulator(FOOD, ENEMIES, 0, MAXX, MAXY);
				var board = sim.getBoard();
				var creature = new Creature(0, 0);
				var worker = new Worker("game.js");
				var timeUntilNew = 0;
				var shouldAskForNew = true;
				
				worker.addEventListener('message', function(e) {
  					if(e.data.genome) {
  						var c = sim.createRandomCreature();
						c.genome.fromJson(e.data.genome);
						replaceCreature(c);
						timeUntilNew = TIMEOUT;
						shouldAskForNew = true;
					} else {
						console.log(e.data);
					}  					
				}, false);
				
				function askForNew() {
					console.log("Asking for new creature");
					worker.postMessage({maxX: MAXX, maxY: MAXY, food: FOOD, enemies: ENEMIES});
					shouldAskForNew = false;
				}

				function replaceCreature(c) {
					board.placeEntity(creature.x, creature.y, null);
					creature = c;
					creature.reset();
					creature.placeOnBoard(board);
					$("#genome").html(genomeToHtml(creature.genome.instructions));
				}
						
				function genomeToHtml(instructions)
				{
					var html = '<ol start=0>';
					var ip = 0;
					
					instructions.forEach(function(instruction) {
						html += "<li class='instruction'>" + stringifyInstruction(instruction).toLowerCase() + "</li>";
						ip++;
					});
					html += "</ol>";
					return html;
				}

				var painter = new Painter(canvas, board);
				
				replaceCreature(creature);
				
				setInterval(function()
					{
						$('#genome li:eq('+creature.ip+')').css("background", "");
						creature.step();
						$('#genome li:eq('+creature.ip+')').css("background", "#aaa");
						$('#rank').text(creature.rank);
						painter.paint();
						if(shouldAskForNew) {
							timeUntilNew--;
							$('#timeout').text(TIMEOUT - timeUntilNew + "/" + TIMEOUT);
							if(timeUntilNew <= 0)  { 
								askForNew();
								timeUntilNew = TIMEOUT;
							}	
						}
					}, 100
				);

				painter.paint();
			});

		</script>
	</head>
	<body>
		<canvas id="board">
		</canvas>
		<div id="genome"></div>
		<div id="rank"></div>
		<div id="timeout"></div>
	</body>
</html>
