<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv='Content-type: text/html; charset=utf-8'>
		<meta charset='utf-8'>
		<title>Bitter Space</title>
		<script type='text/javascript' src='game.js'></script>
		<script type='text/javascript' src='painter.js'></script>
		<style type='text/css'>
			#board, #genome
			{
				/*border: 1px solid black;*/
				display: inline-block;
			}
		</style>
		<script type="text/javascript" src="jquery.js"></script>
		<script type="text/javascript">
			var updateFunction;

			function runSimulation(config)
			{
				if (updateFunction)
				{
					clearInterval(updateFunction);
					updateFunction = null;
				}
				
				var simulatorConfig = {
						cmd: "init", 
						width: config.boardWidth || 30, 
						height: config.boardHeight || 20, 
						foodCount: config.foodCount || 300, 
						enemyCount: config.enemyCount || 100,
						creatureCount: config.creatureCount || 100,
						newBoardEachGeneration: config.newBoardEachGeneration || false
					};
				var simulator = new Simulator(simulatorConfig);
				var ranked = simulator.getCreaturesByRank();
				var board = simulator.getBoard();
				var creature = simulator.createRandomCreature();
				var timeUntilNew = 0;
				var shouldAskForNew = true;
				var TIMEOUT = 30;
					
				var worker = new Worker("game.js");
				
				worker.addEventListener("message", function(e) {
					var cmd = e.data.cmd;
					if(cmd === "new") {
						onNew(e.data.result);
					} else {
						console.log(e.data);
					}
				});
				
				function onNew(msg) {
					replaceCreatureWithNewGenome(msg.genome);
					timeUntilNew = TIMEOUT;
					shouldAskForNew = true;
				}
				
				function askForNew() {
					console.log("Asking for new creature");
					worker.postMessage({ cmd : "new", generations: 10, stepsPerGeneration: 100 });
					shouldAskForNew = false;
				}

				function replaceCreatureWithNewGenome(genome) {
					var c = simulator.createRandomCreature();
					c.genome.fromJson(genome);
					board.placeEntity(creature.x, creature.y, null);
					creature = c;
					creature.reset();
					creature.placeOnBoard(board);
					displayGenome(creature.genome);
				}
								
				var canvas = document.getElementById('board');

				function startSimulator() {
					console.log("Requesting new simulator");
					worker.postMessage(simulatorConfig);			
				}
				
				$("#simrank").text(creature.rank);
				creature.reset();
				creature.placeOnBoard(board);

				function displayGenome(genome) {
					$("#genome").html(genomeToHtml(genome));
				}
				
				function genomeToHtml(genome)
				{
					var instructions = genome.instructions;
					
					var html = '<ol start=0>';
					var ip = 0;
					
					instructions.forEach(function(instruction) {
						html += "<li class='instruction'>" + stringifyInstruction(instruction).toLowerCase() + "</li>";
						ip++;
					});
					html += "</ol>";
					return html;
				}

				startSimulator();
				askForNew();
				
				var painter = new Painter(canvas, board);
				
				updateFunction = setInterval(function()
					{
						$('#genome li:eq('+creature.ip+')').css("background", "");
						creature.step();
						$('#genome li:eq('+creature.ip+')').css("background", "#aaa");
						$('#rank').text(creature.rank);
						$('#enemyhits').text(creature.enemyhits);
						$('#stepcounter').text(creature.stepcounter);
						painter.paint();
						if(shouldAskForNew) {
							timeUntilNew--;
							$('#respawnCounter').text(TIMEOUT - timeUntilNew + "/" + TIMEOUT);
							if(timeUntilNew <= 0)  { 
								askForNew();
								timeUntilNew = TIMEOUT;
							}	
						}
						
					}, 100
				);

				painter.paint();
			}

			function readConfig()
			{
				var config = {
					generations:            parseInt($("#generations").val()),
					stepsPerGeneration:     parseInt($("#steps").val()),
					foodCount:              parseInt($("#foodCount").val()),
					enemyCount:             parseInt($("#enemyCount").val()),
					creatureCount:          parseInt($("#creatureCount").val()),
					boardWidth:             parseInt($("#boardWidth").val()),
					boardHeight:            parseInt($("#boardHeight").val()),
					newBoardEachGeneration: $("#newboard").is(':checked'),
				};
				//console.log(config);
				return config;

			}

			$(document).ready(function()
			{
				runSimulation(readConfig());
			});
		</script>
	</head>
	<body>
		<canvas id="board">
		</canvas>
		<div id="genome"></div>
		<div>Steps until rewspan: <span id="respawnCounter"></span></div>
		<div>Step counter: <span id="stepcounter"></span></div>
		<div>Rank: <span id="rank"></span> (<span id="simrank"></span>)</div>
		<div>Enemy hits: <span id="enemyhits"></span></div>
		<h3>Simulation</h3>
		<table>
			<tr>
				<td><label for="generations">Generations:</label>
				<td><input id="generations" value="10"></input>
			</tr>

			<tr>
				<td><label for="steps">Steps per generation:</label>
				<td><input id="steps" value="20"></input>
			</tr>

			<tr>
				<td><label for="foodCount">foodCount</label>
				<td><input id="foodCount" value="50"></input>
			</tr>

			<tr>
				<td><label for="enemyCount">enemyCount</label>
				<td><input id="enemyCount" value="30"></input>
			</tr>

			<tr>
				<td><label for="creatureCount">creatureCount</label>
				<td><input id="creatureCount" value="100"></input>
			</tr>

			<tr>
				<td><label for="boardWidth">boardWidth</label>
				<td><input id="boardWidth" value="30"></input>
			</tr>

			<tr>
				<td><label for="boardHeight">boardHeight per generation:</label>
				<td><input id="boardHeight" value="20"></input>
			</tr>
		</table>

		<input id="newboard" type="checkbox"></input>
		<label for="newboard">New board per generation</label><br>
		<button onclick="runSimulation(readConfig())">Run simulation</button>
	</body>
</html>
